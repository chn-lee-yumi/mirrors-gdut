user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

# Load dynamic modules. See /usr/share/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # 缓存目录所在磁盘大小为148G，下面所有配置加起来不能超过这个数（建议再小一点，留些空间，所以这里定最大可用空间之和为120G）
    # pypi 缓存
    proxy_cache_path /home/mirror/nginx_cache/pypi levels=2:2 keys_zone=cache_pypi:16m max_size=40G inactive=30d use_temp_path=off;
    # anaconda 缓存
    proxy_cache_path /home/mirror/nginx_cache/anaconda levels=2:2 keys_zone=cache_anaconda:16m max_size=60G inactive=30d use_temp_path=off;
    # kali 缓存
    proxy_cache_path /home/mirror/nginx_cache/kali levels=2:2 keys_zone=cache_kali:16m max_size=20G inactive=30d use_temp_path=off;

    server {
        listen       80 default_server;
        listen       443 default_server ssl;
        listen       [::]:80 default_server;
        listen       [::]:443 default_server ssl;
        server_name  _;
        root         /mnt/mirror;
        ssl_certificate /etc/nginx/conf.d/-.gdut.edu.cn_chain.crt;
        ssl_certificate_key /etc/nginx/conf.d/-.gdut.edu.cn.key;
        ssl_session_cache shared:SSL:1m;
        ssl_prefer_server_ciphers on;
        ssl_protocols TLSv1.2 TLSv1.1 TLSv1;
        ssl_ciphers ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS;

        # location 匹配顺序： 精确匹配（=） > 普通匹配（非/结尾的完整路径） > 常规字符串开头（^~） > 正则（~区分大小写 ~*不区分大小写 匹配成功就停止匹配） > 最长字符串（会遍历location再进行判断）

        # 最后匹配，没有匹配到缓存URL的就访问本地文件
        location / {
            autoindex on;
            autoindex_localtime on;
            autoindex_exact_size off;
            charset utf-8;
        }

        # 主页强制跳转https
        location = / {
            if ( $scheme = http ){
                return 301 https://mirrors.gdut.edu.cn/;
            }
        }

        # pypi 根目录 默认缓存12小时
        location = /pypi/ {
            #slice 1m; # 分片似乎会出bug
            proxy_pass  https://mirrors.cloud.tencent.com; # 回源腾讯云
            #proxy_pass  https://pypi.tuna.tsinghua.edu.cn/; # 回源清华
            #proxy_pass  http://172.17.0.9:8080;
            proxy_cache cache_pypi;
            proxy_cache_key $uri$slice_range;
            proxy_cache_revalidate on;
            proxy_cache_lock on;
            proxy_set_header Range $slice_range;
            proxy_cache_valid any 12h;
            add_header mirror-cache "$upstream_cache_status";
        }

        # pypi 缓存 默认缓存30天
        location /pypi/ {
            #slice 1m; # 分片似乎会出bug
            #proxy_pass  https://mirrors.cloud.tencent.com; # 回源腾讯云
            proxy_pass  https://pypi.tuna.tsinghua.edu.cn/; # 回源清华
            proxy_set_header User-Agent "Nginx Proxy"; # 修改UA，使得清华源会只返回目录内容
            #proxy_pass  http://172.17.0.9:8080;
            proxy_cache cache_pypi;
            proxy_cache_key $uri$slice_range;
            proxy_cache_revalidate on;
            proxy_cache_lock on;
            proxy_set_header Range $slice_range;
            proxy_cache_valid 200 206 30d;
            proxy_cache_valid any 12h;
            add_header mirror-cache "$upstream_cache_status";
        }

        # pypi 缓存 目录、failed_packages.txt的缓存时间12小时 正则表达式不能带斜杠，所以只能回源腾讯云
        location ~ /pypi/($|.*/$|last-modified) {
            #slice 1m; # 分片似乎会出bug
            proxy_pass  https://mirrors.cloud.tencent.com; # 回源腾讯云
            #proxy_pass  https://pypi.tuna.tsinghua.edu.cn/; # 回源清华
            #proxy_set_header User-Agent "Nginx Proxy"; # 修改UA，使得清华源会只返回目录内容
            proxy_cache cache_pypi;
            proxy_cache_key $uri;
            proxy_cache_revalidate on;
            proxy_cache_lock on;
            proxy_cache_valid 200 12h;
            proxy_cache_valid any 1m;
            add_header mirror-cache "$upstream_cache_status";
        }


        # anaconda 缓存 默认缓存30天
        location /anaconda/ {
            slice 1m;
            proxy_pass  https://mirrors.tuna.tsinghua.edu.cn; # 回源清华
            proxy_set_header User-Agent "Nginx Proxy"; # 修改UA，使得清华源会只返回目录内容
            proxy_cache cache_anaconda;
            proxy_cache_key $uri$slice_range;
            proxy_cache_revalidate on;
            proxy_cache_lock on;
            proxy_set_header Range $slice_range;
            proxy_cache_valid 200 206 30d;
            proxy_cache_valid any 12h;
            add_header mirror-cache "$upstream_cache_status";
        }

        # anaconda 缓存 目录、failed_packages.txt的缓存时间12小时
        location ~ /anaconda/($|.*/$|failed_packages.txt) {
            slice 1m;
            proxy_pass  https://mirrors.tuna.tsinghua.edu.cn; # 回源清华
            proxy_set_header User-Agent "Nginx Proxy";
            proxy_cache cache_anaconda;
            proxy_cache_key $uri;
            proxy_cache_revalidate on;
            proxy_cache_lock on;
            proxy_cache_valid 200 12h;
            proxy_cache_valid any 1m;
            add_header mirror-cache "$upstream_cache_status";
        }

        # anaconda 缓存 repodata.json、repodata.json.bz2和current_repodata.json缓存时间12小时
        location ~ /anaconda/.*/(repodata.json|repodata.json.bz2|current_repodata.json)$ {
            slice 1m;
            proxy_pass  https://mirrors.tuna.tsinghua.edu.cn; # 回源清华
            proxy_set_header User-Agent "Nginx Proxy";
            proxy_cache cache_anaconda;
            proxy_cache_key $uri;
            proxy_cache_revalidate on;
            proxy_cache_lock on;
            proxy_cache_valid 200 12h;
            proxy_cache_valid any 1m;
            add_header mirror-cache "$upstream_cache_status";
        }

        # kali 缓存 默认缓存30天
        location /kali/ {
            slice 1m;
            proxy_pass  https://mirrors.cloud.tencent.com; # 回源腾讯云
            proxy_cache cache_kali;
            proxy_cache_key $uri$slice_range;
            proxy_cache_revalidate on;
            proxy_cache_lock on;
            proxy_set_header Range $slice_range;
            proxy_cache_valid 200 206 30d;
            proxy_cache_valid any 12h;
            add_header mirror-cache "$upstream_cache_status";
        }

        # kali 缓存 目录、Packages、Packages.gz的缓存时间12小时
        location ~ /kali/($|.*/$|Packages|Packages.gz) {
            slice 1m;
            proxy_pass  https://mirrors.cloud.tencent.com; # 回源腾讯云
            proxy_cache cache_kali;
            proxy_cache_key $uri;
            proxy_cache_revalidate on;
            proxy_cache_lock on;
            proxy_cache_valid 200 12h;
            proxy_cache_valid any 1m;
            add_header mirror-cache "$upstream_cache_status";
        }

        # nexus
        location /nexus/ {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://222.200.97.225:9000/nexus/;
            proxy_connect_timeout       3000;
            proxy_send_timeout          3000;
            proxy_read_timeout          3000;
            send_timeout                3000;
        }

        # maven
        location /maven/ {
            rewrite ^/(.*) /nexus/#browse/browse:maven permanent;
        }

        # npm
        location /npm/ {
            rewrite ^/(.*) /nexus/#browse/browse:npm permanent;
        }

    }

}